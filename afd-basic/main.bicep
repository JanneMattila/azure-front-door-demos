param location string = resourceGroup().location
param backendAddress1 string
param backendAddress2 string
param frontDoorName string

var skuName = 'Premium_AzureFrontDoor'

resource frontDoorProfile 'Microsoft.Cdn/profiles@2024-09-01' = {
  name: frontDoorName
  location: 'global'
  identity: {
    type: 'SystemAssigned'
  }
  properties: {
    logScrubbing: {
      scrubbingRules: []
      state: 'Disabled'
    }
    originResponseTimeoutSeconds: 20
  }
  sku: {
    name: skuName
  }
}

resource endpoint 'Microsoft.Cdn/profiles/afdEndpoints@2024-09-01' = {
  name: 'endpoint1'
  location: 'global'
  parent: frontDoorProfile
  properties: {
    autoGeneratedDomainNameLabelScope: 'TenantReuse'
    enabledState: 'Enabled'
  }
}

resource originGroup1 'Microsoft.Cdn/profiles/originGroups@2020-09-01' = {
  name: 'origingroup1'
  parent: frontDoorProfile
  properties: {
    sessionAffinityState: 'Disabled'
    loadBalancingSettings: {
      sampleSize: 4
      successfulSamplesRequired: 2
      additionalLatencyInMilliseconds: 0
    }
    healthProbeSettings: {
      probePath: '/'
      probeRequestType: 'HEAD'
      probeProtocol: 'Https'
      probeIntervalInSeconds: 15
    }
  }
}

resource originGroup2 'Microsoft.Cdn/profiles/originGroups@2020-09-01' = {
  name: 'origingroup2'
  parent: frontDoorProfile
  properties: {
    sessionAffinityState: 'Disabled'
    loadBalancingSettings: {
      sampleSize: 4
      successfulSamplesRequired: 2
      additionalLatencyInMilliseconds: 0
    }
    healthProbeSettings: {
      probePath: '/'
      probeRequestType: 'HEAD'
      probeProtocol: 'Https'
      probeIntervalInSeconds: 15
    }
  }
}

resource origin1 'Microsoft.Cdn/profiles/originGroups/origins@2020-09-01' = {
  name: 'origin1'
  parent: originGroup1
  properties: {
    hostName: backendAddress1
    originHostHeader: backendAddress1
    httpPort: 80
    httpsPort: 443
    priority: 2
    weight: 10
  }
}

resource origin2 'Microsoft.Cdn/profiles/originGroups/origins@2020-09-01' = {
  name: 'origin2'
  parent: originGroup2
  properties: {
    hostName: backendAddress2
    originHostHeader: backendAddress2
    httpPort: 80
    httpsPort: 443
    priority: 1
    weight: 10
  }
}

resource ruleSet1 'Microsoft.Cdn/profiles/ruleSets@2024-02-01' = {
  name: 'ruleSet1'
  parent: frontDoorProfile
}

resource ruleSet2 'Microsoft.Cdn/profiles/ruleSets@2024-02-01' = {
  name: 'ruleSet2'
  parent: frontDoorProfile
}

resource rule1 'Microsoft.Cdn/profiles/ruleSets/rules@2024-02-01' = {
  name: 'rule1'
  parent: ruleSet1
  properties: {
    order: 100
    conditions: [
      {
        name: 'UrlPath'
        parameters: {
          typeName: 'DeliveryRuleUrlPathMatchConditionParameters'
          operator: 'BeginsWith'
          negateCondition: false
          matchValues: [
            '/echo'
          ]
          transforms: [
            'Lowercase'
            'Trim'
          ]
        }
      }
    ]
    actions: [
      {
        name: 'RouteConfigurationOverride'
        parameters: {
          typeName: 'DeliveryRuleRouteConfigurationOverrideActionParameters'
        }
      }
    ]
    matchProcessingBehavior: 'Continue'
  }
}

resource rule2 'Microsoft.Cdn/profiles/ruleSets/rules@2024-02-01' = {
  name: 'rule2'
  parent: ruleSet2
  properties: {
    order: 100
    conditions: []
    actions: [
      {
        name: 'UrlRewrite'
        parameters: {
          typeName: 'DeliveryRuleUrlRewriteActionParameters'
          sourcePattern: '/'
          destination: '/'
          preserveUnmatchedPath: false
        }
      }
    ]
    matchProcessingBehavior: 'Continue'
  }
}

resource route1 'Microsoft.Cdn/profiles/afdEndpoints/routes@2020-09-01' = {
  name: 'route1'
  parent: endpoint
  dependsOn: [
    origin1
  ]
  properties: {
    originGroup: {
      id: originGroup1.id
    }
    supportedProtocols: [
      'Http'
      'Https'
    ]
    patternsToMatch: [
      '/*'
    ]
    queryStringCachingBehavior: 'UseQueryString'
    forwardingProtocol: 'HttpsOnly'
    linkToDefaultDomain: 'Enabled'
    httpsRedirect: 'Enabled'
    compressionSettings: {
      isCompressionEnabled: true
      contentTypesToCompress: [
        'text/html'
        'text/plain'
        'text/css'
        'application/javascript'
        'application/json'
        'application/xml'
        'image/svg+xml'
      ]
    }
    ruleSets: [
      {
        id: ruleSet1.id
      }
    ]
  }
}

resource route2 'Microsoft.Cdn/profiles/afdEndpoints/routes@2024-02-01' = {
  name: 'route2'
  parent: endpoint
  dependsOn: [
    origin2
  ]
  properties: {
    originGroup: {
      id: originGroup2.id
    }
    supportedProtocols: [
      'Http'
      'Https'
    ]
    patternsToMatch: [
      '/ip/*'
      '/ip'
    ]
    originPath: '/'
    forwardingProtocol: 'HttpsOnly'
    linkToDefaultDomain: 'Enabled'
    httpsRedirect: 'Enabled'
    cacheConfiguration: null
    ruleSets: [
      {
        id: ruleSet2.id
      }
    ]
  }
}

resource firewallPolicy 'Microsoft.Network/FrontDoorWebApplicationFirewallPolicies@2025-03-01' = {
  name: 'wafpolicy'
  location: 'global'
  sku: {
    name: skuName
  }
  properties: {
    policySettings: {
      mode: 'Prevention'
      customBlockResponseStatusCode: 403
      customBlockResponseBody: loadFileAsBase64('403.html')
    }
    customRules: {
      rules: [
        {
        priority: 10
        name: 'RuleAllowCorporateIPs'
        action: 'Allow'
        ruleType: 'MatchRule'
        matchConditions: [
          {
            operator: 'IPMatch'
            matchVariable: 'SocketAddr'
            matchValue: [
              '192.168.0.0/16'
            ]
          }
        ]
      }
      {
        priority: 30
        name: 'RuleBlockIPs'
        action: 'Block'
        ruleType: 'MatchRule'
        matchConditions: [
          {
            operator: 'IPMatch'
            matchVariable: 'SocketAddr'
            matchValue: [
              '1.2.3.4'
              '2.3.4.5'
            ]
          }
        ]
      }
      {
        priority: 31
        name: 'RuleBlockCustomHeader'
        action: 'Block'
        ruleType: 'MatchRule'
        matchConditions: [
          {
            operator: 'Contains'
            negateCondition: false
            transforms: [
              'Lowercase'
            ]
            selector: 'x-custom-header'
            matchVariable: 'RequestHeader'
            matchValue: [
              'block-me'
            ]
          }
        ]
      }
      {
        priority: 50
        name: 'RuleGeoDeny'
        action: 'Log'
        ruleType: 'MatchRule'
        matchConditions: [
          {
            operator: 'GeoMatch'
            negateCondition: true
            transforms: []
            matchVariable: 'SocketAddr'
            matchValue: [
              'FI' // Finland
              'AX' // Ã…land Islands
              'SE' // Sweden
              'NO' // Norway
              'DK' // Denmark
              'EE' // Estonia
              'LV' // Latvia
              'LT' // Lithuania
            ]
          }
        ]
      }
      {
        priority: 90
        name: 'RuleRateLimit'
        action: 'Block'
        ruleType: 'RateLimitRule'
        rateLimitThreshold: 20
        enabledState: 'Enabled'
        rateLimitDurationInMinutes: 1
        groupBy: [
          {
            variableName: 'SocketAddr'
          }
        ]
        matchConditions: [
          {
            operator: 'IPMatch'
            negateCondition: true
            matchVariable: 'SocketAddr'
            matchValue: [
              '255.255.255.255/32'
            ]
          }
        ]
      }
    ]}
    managedRules: {
      managedRuleSets: [
        {
          ruleSetType: 'Microsoft_DefaultRuleSet'
          ruleSetVersion: '2.1'
          ruleSetAction: 'Block'
        }
        {
          ruleSetType: 'Microsoft_BotManagerRuleSet'
          ruleSetVersion: '1.1'
        }
      ]
    }
  }
}

resource securityPolicy 'Microsoft.Cdn/profiles/securityPolicies@2021-06-01' = {
  name: 'security-policy'
  parent: frontDoorProfile
  properties: {
    parameters: {
      type: 'WebApplicationFirewall'
      wafPolicy: {
        id: firewallPolicy.id
      }
      associations: [
        {
          domains: [
            {
              id: endpoint.id
            }
          ]
          patternsToMatch: [
            '/*'
          ]
        }
      ]
    }
  }
}

module monitoring './monitoring.bicep' = {
  name: 'monitoring'
  params: {
    parentName: frontDoorProfile.name
    location: location
  }
}

output fqdn string = endpoint.properties.hostName
output frontDoorId string = frontDoorProfile.properties.frontDoorId
